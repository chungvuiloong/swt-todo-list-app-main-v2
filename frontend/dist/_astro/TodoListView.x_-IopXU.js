import{e as ye,c as B,g as b,t as S,b as $,i as n,d as g,m as te,a as z,f as Te,h as q,r as Le,j as Ee,k as ke,l as Fe,o as Y,F as Ne}from"./store.BVrLplq6.js";import{u as Oe}from"./userState.D8IPT1p-.js";import{t as C,a as Je}from"./todoActions.CcFcA-pD.js";import{I as k}from"./IconButton.ZQ257svR.js";import{T as oe}from"./TextInput.DV86XHqt.js";import{c as ie,F as ne,r as le,A as Z}from"./FormError.BjAbR7KG.js";import{I as je}from"./iconify.ByqseDuz.js";const G=ye([]);var Me=S('<div class="mt-2 flex justify-between"><!$><!/><!$><!/>'),We=S('<div class="flex max-w-2xl flex-col justify-center self-center "><div class="container prose mb-2"><h1>New todo task</h1></div><!$><!/><!$><!/>');function De(l){const[d,{Form:u,Field:i}]=ie(),[f,c]=G,[F,h]=B(),w=s=>{console.log("submitting create todo item form with values:",s),d.internal.fields.description?.value.set(""),C.createTodoItem(l.todoListId,s).then(o=>{console.log("todo item created:",o),c(f.length,o),d.internal.fields.description?.value.set(""),h(void 0),l.onSuccess?.(o)}).catch(o=>{console.log("error:",o),h(o.message)})};return(()=>{var s=b(We),o=s.firstChild,T=o.nextSibling,[x,v]=$(T.nextSibling),L=x.nextSibling,[M,N]=$(L.nextSibling);return n(s,g(ne,{get error(){return F()},formName:"createTodoItem"}),x,v),n(s,g(u,{onSubmit:w,get children(){return[g(i,{name:"description",get validate(){return[le("Description cannot be empty")]},children:(p,I)=>g(oe,te(I,{label:"Description",type:"textarea",get value(){return p.value},get error(){return p.error},required:!0}))}),(()=>{var p=b(Me),I=p.firstChild,[O,t]=$(I.nextSibling),a=O.nextSibling,[m,e]=$(a.nextSibling);return n(p,g(Z,{type:"button",get loading(){return d.submitting},label:"Close",variant:"secondary",onClick:()=>l.onClose?.()}),O,t),n(p,g(Z,{get loading(){return d.submitting},label:"Create",variant:"primary"}),m,e),p})()]}}),M,N),s})()}var Ae=S('<div class=flex><div class=flex-grow></div><div class="flex h-fit flex-shrink flex-row"><!$><!/><!$><!/><!$><!/>'),qe=S('<div class="flex flex-grow flex-col justify-center self-center "><!$><!/><!$><!/>');function Be(l){const[d,u]=G,[i,{Form:f,Field:c}]=ie({initialValues:{description:l.editState.description}});z(()=>{i.internal.fields.description?.value.set(l.editState.description)});const[F,h]=B(),w=s=>{console.log("submitting edit todo item form with values:",s),C.updateTodoItem(l.todoItem.todo_list_id,l.todoItem.id,s).then(o=>{console.log("todo item edited:",o),u(l.todoItemIndex,o),i.internal.fields.description?.value.set(""),h(void 0),l.onSuccess(o)}).catch(o=>{console.log("setting error:",o),h(o.message)})};return(()=>{var s=b(qe),o=s.firstChild,[T,x]=$(o.nextSibling),v=T.nextSibling,[L,M]=$(v.nextSibling);return n(s,g(ne,{get error(){return F()},formName:"editTodoItem"}),T,x),n(s,g(f,{onSubmit:w,get children(){var N=b(Ae),p=N.firstChild,I=p.nextSibling,O=I.firstChild,[t,a]=$(O.nextSibling),m=t.nextSibling,[e,r]=$(m.nextSibling),_=e.nextSibling,[y,U]=$(_.nextSibling);return n(p,g(c,{name:"description",get validate(){return[le("Description cannot be empty")]},children:(P,R)=>g(oe,te(R,{type:"textarea",get value(){return P.value},get error(){return P.error},onInput:W=>{R.onInput(W),l.onInput(W.currentTarget.value)},required:!0,autofocus:!0}))})),n(I,g(k,{get loading(){return i.submitting},icon:"fluent:save-20-regular",iconClass:"text-blue-400",type:"submit"}),t,a),n(I,g(k,{get loading(){return i.submitting},icon:"fluent:edit-off-20-regular",iconClass:"text-yellow-600",onClick:()=>l.onClose?.()}),e,r),n(I,g(k,{icon:"fluent:delete-20-regular",iconClass:"text-gray-600",disabled:!0}),y,U),N}}),L,M),s})()}var Pe=S('<div class="mt-2 flex max-w-full items-center justify-between border-t-2 border-gray-200 pb-4 pt-4">'),Re=S('<span class="scroll-ms-4 overflow-x-auto whitespace-pre-wrap text-xl">'),Ue=S("<div class=flex><!$><!/><!$><!/><!$><!/>");const He=l=>{const{todoItem:d,index:u}=l;return console.log("editState",l.editState),(()=>{var i=b(Pe);return n(i,(()=>{var f=q(()=>!!l.editState);return()=>f()?g(Be,{todoItemIndex:u,todoItem:d,get editState(){return l.editState},onSuccess:c=>{l.update(u,c)},onInput:c=>l.updateEditState(u,{description:c}),onClose:()=>l.updateEditState(u,void 0)}):[(()=>{var c=b(Re);return c.$$click=()=>l.toggleComplete(u),n(c,()=>d.description),Le(),c})(),(()=>{var c=b(Ue),F=c.firstChild,[h,w]=$(F.nextSibling),s=h.nextSibling,[o,T]=$(s.nextSibling),x=o.nextSibling,[v,L]=$(x.nextSibling);return n(c,g(k,{icon:"fluent:copy-20-regular",iconClass:"text-sky-700",onClick:()=>l.clone(u)}),h,w),n(c,g(k,{icon:"fluent:edit-20-regular",iconClass:"text-yellow-600",onClick:()=>l.updateEditState(u,{description:d.description})}),o,T),n(c,g(k,{icon:"fluent:delete-20-regular",iconClass:"text-orange-800",onClick:()=>l.delete(u)}),v,L),c})()]})()),Ee(f=>(f=d.completed?"line-through":"none")!=null?i.style.setProperty("text-decoration",f):i.style.removeProperty("text-decoration")),i})()};Te(["click"]);const ee="ws://localhost:4322/ws/",Ve=(l,d)=>{const u=new WebSocket(`${ee}todo-list/${d}?access_token=${l.accessToken}`);return u.onopen=()=>{console.log(`editTodoListWs: connected to ${ee}todo-list/${d}`)},u.onerror=i=>{console.error("editTodoListWs: error:",i)},u.onclose=()=>{console.log("editTodoListWs: closed")},u};var ze=S('<div class="flex w-full max-w-3xl grow flex-col"data-testid=todos-page>'),Ge=S('<div class="container prose mb-8 w-full max-w-full pb-2 "><h1><!$><!/><!$><!/></h1><p class=whitespace-pre-wrap></p><!$><!/>'),Ke=S('<div class="flex w-full max-w-full flex-col">'),Qe=S('<div class="over container mt-16 w-full max-w-full">'),Xe=S("<span> ("),Ye=S("<span><!$><!/>)"),Ze=S("<div><h3>Members</h3><ul><li><!$><!/><!$><!/></li><!$><!/>"),et=S("<li><!$><!/> - <!$><!/> <!$><!/>");function dt(l){const[d,u]=Je,[i,f]=G,[c,F]=Oe,[h,w]=B(!1),s=l.todoListId??d.todoList?.id,[o,T]=B(void 0),[x,v]=B(Object.fromEntries(i.map((t,a)=>[a,void 0])));console.log("tiEditState",x()),z(Y(()=>o(),t=>{console.log("active.todoList",d.todoList),t&&(t.onmessage=a=>{const m=a.data,e=JSON.parse(m);if(console.log("received message:",e),e.action==="init"){const r=e.data.users;Object.keys(r).forEach(_=>{console.log("userId",_),u("todoList","members",y=>y.user.id===parseInt(_),"active",!0)})}if(e.action==="connect"){if(e.user.id===c.userId)return;u("todoList","members",r=>r.user.id===e.user.id,"active",!0)}if(e.action==="disconnect"&&u("todoList","members",r=>r.user.id===e.user.id,"active",!1),e.action==="todo_item_create"){const r=e.todo_item_id;C.fetchTodoItem(s,r).then(_=>{_&&f([...i,_])})}if(e.action==="todo_item_delete"){const r=e.todo_item_id;f(i.filter(_=>_.id!==r))}if(e.action==="todo_item_open_for_editing"){const r=i.findIndex(_=>_.id===e.todo_item_id);v({...x(),[r]:{description:i[r].description}})}if(e.action==="todo_item_edit_description"){console.log("todo_item_edit_description",e);const r=i.findIndex(_=>_.id===e.todo_item_id);v({...x(),[r]:{description:e.description}})}if(e.action==="todo_item_close_editing"){const r=i.findIndex(_=>_.id===e.todo_item_id);v({...x(),[r]:void 0})}if(e.action==="todo_item_update"){const r=i.findIndex(_=>_.id===e.todo_item_id);v({...x(),[r]:void 0}),C.fetchTodoItem(s,e.todo_item_id).then(_=>{f(r,_)})}})}));const L=(t,a)=>{o()&&console.log("sending edit description:",a),o()?.send(JSON.stringify({action:"todo_item_edit_description",todo_item_id:t,description:a}))},M=t=>{o()?.send(JSON.stringify({action:"todo_item_close_editing",todo_item_id:t}))},N=t=>{const a=i[t];C.updateTodoItem(s,a.id,{completed:!a.completed}).then(()=>{f(t,{...a,completed:!a.completed}),o()?.send(JSON.stringify({action:"todo_item_update",todo_item_id:a.id}))})},p=t=>{console.log("deleteTodoItem",t),console.log("todoItems",i),C.deleteTodoItem(s,i[t].id).then(()=>{f(i.filter((a,m)=>m!==t)),o()?.send(JSON.stringify({action:"todo_item_delete",todo_item_id:i[t].id}))})},I=(t,a)=>{v({...x(),[t]:void 0}),f(t,a),o()?.send(JSON.stringify({action:"todo_item_update",todo_item_id:a.id}))},O=t=>{const a=i[t];C.cloneTodoItem(s,a.id).then(m=>{o()?.send(JSON.stringify({action:"todo_item_create",todo_item_id:m.id})),f(i.length,m)})};return z(Y(()=>c,t=>t&&!t.username&&location.assign("/login"))),ke(async()=>{if(s){const t=await C.fetchTodoList(s),a=await C.fetchTodoListMembers(s);a.push({user:t.author,role:{id:0,name:"owner"},active:!1}),u("todoList",{...t,members:a});const m=d.todoList?.members,e=m?m.length>1||m[0]?.user.id!==d.todoList?.author.id:!1;C.fetchTodoItems(s).then(f),e&&T(Ve(c,s))}else location.assign("/todo-lists")}),Fe(()=>{console.log("cleaning up todo list view"),u("todoList",null),f([]),o()?.close()}),c.username&&(()=>{var t=b(ze);return n(t,(()=>{var a=q(()=>!!d.todoList?.name);return()=>a()&&[(()=>{var m=b(Ge),e=m.firstChild,r=e.firstChild,[_,y]=$(r.nextSibling),U=_.nextSibling,[P,R]=$(U.nextSibling),W=e.nextSibling,se=W.nextSibling,[re,de]=$(se.nextSibling);return n(e,()=>d.todoList?.name,_,y),n(e,(()=>{var H=q(()=>!!(o()&&c.userId!==d.todoList.author.id));return()=>H()&&[b(Xe),g(je,{class:"mr-1 align-bottom",icon:"fluent:person-circle-20-regular"}),(()=>{var J=b(Ye),V=J.firstChild,[D,j]=$(V.nextSibling);return D.nextSibling,n(J,()=>d.todoList?.author.username,D,j),J})()]})(),P,R),n(W,()=>d.todoList?.description),n(m,(()=>{var H=q(()=>(d.todoList?.members?.length??0)>1);return()=>H()&&(()=>{var J=b(Ze),V=J.firstChild,D=V.nextSibling,j=D.firstChild,ae=j.firstChild,[K,ce]=$(ae.nextSibling),me=K.nextSibling,[_e,ue]=$(me.nextSibling),$e=j.nextSibling,[ge,fe]=$($e.nextSibling);return n(j,()=>`${c.username} (you) - `,K,ce),n(j,()=>d.todoList?.members?.find(E=>E.user.id===c.userId)?.role.name,_e,ue),n(D,()=>d.todoList?.members?.filter(E=>E.user.id!==c.userId).map(E=>(()=>{var A=b(et),xe=A.firstChild,[Q,be]=$(xe.nextSibling),Se=Q.nextSibling,ve=Se.nextSibling,[X,pe]=$(ve.nextSibling),he=X.nextSibling,Ie=he.nextSibling,[Ce,we]=$(Ie.nextSibling);return n(A,()=>E.user.username,Q,be),n(A,()=>E.role.name,X,pe),n(A,()=>E.active?" (present)":"",Ce,we),A})()),ge,fe),J})()})(),re,de),m})(),(()=>{var m=b(Ke);return n(m,(()=>{var e=q(()=>!!h());return()=>e()?g(De,{get todoListId(){return d.todoList?.id},onSuccess:r=>{w(!1),o()?.send(JSON.stringify({action:"todo_item_create",todo_item_id:r.id}))},onClose:()=>w(!1)}):g(k,{icon:"system-uicons:create",iconClass:"text-yellow-500",label:"New task",onClick:()=>(console.log("showCreateTodoItemForm"),h(),w(!0))})})()),m})(),(()=>{var m=b(Qe);return n(m,g(Ne,{each:i,children:(e,r)=>g(He,{todoItem:e,get index(){return r()},get editState(){return x()[r()]},updateEditState:(_,y)=>{v({...x(),[_]:y}),y?L(e.id,y.description):M(e.id)},get ws(){return o()},toggleComplete:N,update:I,delete:p,clone:O})})),m})()]})()),t})()}export{dt as default};
